<!-- Tambahkan di head -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

<script>
  // ===== Supabase setup =====
  const supabaseUrl = 'https://nqkmqmilofnmvjgyibdk.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xa21xbWlsb2ZubXZqZ3lpYmRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NjUwNzUsImV4cCI6MjA4NjE0MTA3NX0.1kx_xeDTey3_PqMMKG4DPTNeE7vhFYA29r-tOG3LjQw';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // ===== Override stock variable =====
  let stock = [];

  // ===== Fetch stock dari Supabase =====
  async function fetchStock() {
    const { data, error } = await supabase
      .from('products')  // ganti dengan nama tabel kamu
      .select('*')
      .order('id', { ascending: true });

    if(error){
      console.error('Error fetch:', error);
      return;
    }

    stock = data.map(item => ({
      nama: item.name,
      harga: item.price,
      jumlah: item.stock,
      expired: item.expired || []
    }));

    render();
  }

  // ===== Tambah barang ke Supabase =====
  async function tambahBarang(){
    const nama = document.getElementById("nama").value.trim();
    const harga = parseInt(document.getElementById("harga").value);
    const jumlah = parseInt(document.getElementById("jumlah").value);

    if(!nama || isNaN(harga) || isNaN(jumlah)){alert("Semua field wajib diisi!"); return;}

    const { data, error } = await supabase.from('products').insert([
      { name: nama, price: harga, stock: jumlah, expired: [] }
    ]);

    if(error){alert('Gagal tambah barang: '+error.message); return;}
    closeModal();
    fetchStock();
  }

  // ===== Ubah jumlah barang di Supabase =====
  async function ubah(index, nilai){
    const item = stock[index];
    const newJumlah = item.jumlah + nilai;
    if(newJumlah < 0) return;

    if(newJumlah === 0){
      if(!confirm("Hapus barang ini?")) return;
      await supabase.from('products').delete().eq('name', item.nama);
    } else {
      await supabase.from('products')
        .update({ stock: newJumlah })
        .eq('name', item.nama);
    }

    fetchStock();
  }

  // ===== Simpan expired di Supabase =====
  async function simpanExpired(){
    const val = document.getElementById("expiredInput").value.trim();
    if(!val){alert("Tanggal tidak boleh kosong"); return;}
    const item = stock[currentIndexExpired];
    const newExpired = item.expired ? [...item.expired, val] : [val];

    await supabase.from('products')
      .update({ expired: newExpired })
      .eq('name', item.nama);

    closeModalExpired();
    fetchStock();
  }

  async function updateExpired(i){
    const val = document.getElementById(`editExpiredInput-${i}`).value.trim();
    if(!val){alert("Tanggal tidak boleh kosong"); return;}
    const item = stock[currentIndexEditExpired];
    const newExpired = [...item.expired];
    newExpired[i] = val;

    await supabase.from('products')
      .update({ expired: newExpired })
      .eq('name', item.nama);

    fetchStock();
  }

  async function hapusExpired(i){
    const item = stock[currentIndexEditExpired];
    const newExpired = [...item.expired];
    newExpired.splice(i,1);

    await supabase.from('products')
      .update({ expired: newExpired })
      .eq('name', item.nama);

    fetchStock();
  }

  // ===== Init =====
  fetchStock();  // ambil data dari Supabase saat load
</script>
