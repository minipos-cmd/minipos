<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>MiniPOS - Stock Barang</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#f4f4f4; }
header { background:#4CAF50; color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
.container { padding:20px; }
button { padding:6px 12px; cursor:pointer; margin:2px; }
table { width:100%; border-collapse:collapse; background:white; margin-top:15px; }
th, td { padding:10px; border-bottom:1px solid #ddd; text-align:center; }
.summary { margin-top:15px; padding:10px; background:white; border-radius:8px; display:flex; justify-content:space-between; font-weight:bold; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:white; padding:20px; width:320px; border-radius:8px; text-align:center; }
.modal-content input { width:100%; padding:8px; margin-bottom:10px; box-sizing:border-box; }
.expired-date { display:inline-block; background:#e0e0e0; padding:2px 6px; border-radius:4px; margin:2px; transition: background 0.3s; }
.expired-date.highlight { background:#fff176; }
</style>
</head>
<body>

<header>
<h2>Stock Barang</h2>
<button onclick="back()">⬅ Dashboard</button>
</header>

<div class="container">
<button onclick="openModal()">➕ Tambah Barang</button>

<table>
  <thead>
    <tr>
      <th>No</th>
      <th>Nama Barang</th>
      <th>Harga</th>
      <th>Jumlah</th>
      <th>Aksi</th>
      <th>Expired</th>
    </tr>
  </thead>
  <tbody id="stockList"></tbody>
</table>

<div class="summary">
  <div>Total Barang : <span id="totalBarang">0</span></div>
  <div>Jumlah Total : Rp. <span id="totalJumlah">0</span></div>
</div>
</div>

<!-- Modal Tambah Barang -->
<div class="modal" id="modal">
<div class="modal-content">
<h3>Tambah Barang</h3>
<input type="text" id="nama" placeholder="Nama Barang">
<input type="number" id="harga" placeholder="Harga (Rp)">
<input type="number" id="jumlah" placeholder="Jumlah">
<button onclick="tambahBarang()">Simpan</button>
<button onclick="closeModal()">Batal</button>
</div>
</div>

<!-- Modal Tambah Expired -->
<div class="modal" id="modalExpired">
<div class="modal-content">
<h3>Tambah Expired</h3>
<input type="text" id="expiredInput" placeholder="DD-MM-YYYY">
<button onclick="simpanExpired()">Simpan</button>
<button onclick="closeModalExpired()">Batal</button>
</div>
</div>

<!-- Modal Edit Expired -->
<div class="modal" id="modalEditExpired">
<div class="modal-content">
<h3>Edit / Hapus Expired</h3>
<div id="expiredEditList"></div>
<button onclick="closeModalEditExpired()">Tutup</button>
</div>
</div>

<!-- Firebase -->
<script src="firebase.js"></script>

<script>
// Proteksi login
if(localStorage.getItem("login")!=="true"){window.location.href="index.html";}

let stock = [];
let firebaseIds = []; // untuk simpan doc.id
let currentIndexExpired = null;
let currentIndexEditExpired = null;

// --- Render Tabel ---
function render(){
  const list = document.getElementById("stockList");
  list.innerHTML = "";
  let totalBarang = 0;
  let totalJumlah = 0;

  stock.forEach((item,index)=>{
    const expiredHtml = item.expired ? item.expired.map(date=>`<span class="expired-date">${date}</span>`).join(" ") : "";
    list.innerHTML += `
      <tr>
        <td>${index+1}</td>
        <td>${item.nama}</td>
        <td>Rp ${item.harga.toLocaleString('id-ID')}</td>
        <td>${item.jumlah}</td>
        <td>
          <button onclick="ubah(${index},1)">+</button>
          <button onclick="ubah(${index},-1)">-</button>
          <button onclick="openModalExpired(${index})">+ Exp</button>
          <button onclick="editExpired(${index})">Edit Exp</button>
        </td>
        <td>${expiredHtml}</td>
      </tr>
    `;
    totalBarang += item.jumlah;
    totalJumlah += item.jumlah*item.harga;
  });

  document.getElementById("totalBarang").innerText = totalBarang;
  document.getElementById("totalJumlah").innerText = totalJumlah.toLocaleString("id-ID");
}

// --- Load Stock dari Firebase ---
function loadStockFromFirebase(){
  db.collection("products").get().then(snapshot=>{
    stock = [];
    firebaseIds = [];
    snapshot.forEach(doc=>{
      const data = doc.data();
      stock.push({
        nama: data.name,
        harga: data.price,
        jumlah: data.quantity,
        expired: data.expired || []
      });
      firebaseIds.push(doc.id);
    });
    render();
  }).catch(console.error);
}

// --- Simpan / Update ke Firebase ---
function simpanStockToFirebase(item){
  db.collection("products").add({
    name: item.nama,
    price: item.harga,
    quantity: item.jumlah,
    expired: item.expired || []
  }).then(docRef=>{
    firebaseIds.push(docRef.id);
  }).catch(console.error);
}

function updateStockInFirebase(index){
  const docId = firebaseIds[index];
  if(!docId) return;
  db.collection("products").doc(docId).set({
    name: stock[index].nama,
    price: stock[index].harga,
    quantity: stock[index].jumlah,
    expired: stock[index].expired || []
  }).catch(console.error);
}

// --- Tambah Barang ---
function tambahBarang(){
  const nama = document.getElementById("nama").value.trim();
  const harga = parseInt(document.getElementById("harga").value);
  const jumlah = parseInt(document.getElementById("jumlah").value);
  if(!nama||isNaN(harga)||isNaN(jumlah)){alert("Semua field wajib diisi!"); return;}
  const item = {nama,harga,jumlah,expired:[]};
  stock.push(item);
  simpanStockToFirebase(item);
  closeModal();
  render();
}

// --- Ubah jumlah ---
function ubah(index,nilai){
  if(stock[index].jumlah+nilai<0) return;
  stock[index].jumlah += nilai;
  if(stock[index].jumlah===0){if(confirm("Hapus barang ini?")){stock.splice(index,1); firebaseIds.splice(index,1);}}
  render();
  updateStockInFirebase(index);
}

// --- Modal Barang ---
function openModal(){document.getElementById("modal").style.display="flex";}
function closeModal(){document.getElementById("modal").style.display="none"; document.getElementById("nama").value=""; document.getElementById("harga").value=""; document.getElementById("jumlah").value="";}

// --- Modal Expired ---
function openModalExpired(index){currentIndexExpired=index; document.getElementById("expiredInput").value=""; document.getElementById("modalExpired").style.display="flex";}
function closeModalExpired(){document.getElementById("modalExpired").style.display="none";}

// --- Modal Edit Expired ---
function editExpired(index){
  currentIndexEditExpired=index;
  const expiredList=stock[index].expired||[];
  const container=document.getElementById("expiredEditList");
  container.innerHTML="";
  expiredList.forEach((date,i)=>{
    container.innerHTML += `
      <div>
        <input type="text" id="editExpiredInput-${i}" value="${date}">
        <button onclick="updateExpired(${i})">Simpan</button>
        <button onclick="hapusExpired(${i})">Hapus</button>
      </div>
    `;
  });
  document.getElementById("modalEditExpired").style.display="flex";
}
function closeModalEditExpired(){document.getElementById("modalEditExpired").style.display="none";}

// --- Tambah Expired ---
function simpanExpired(){
  const val=document.getElementById("expiredInput").value.trim();
  if(!val){alert("Tanggal tidak boleh kosong"); return;}
  if(!stock[currentIndexExpired].expired) stock[currentIndexExpired].expired=[];
  stock[currentIndexExpired].expired.push(val);
  updateStockInFirebase(currentIndexExpired);
  closeModalExpired();
  render();
}

// --- Edit / Hapus Expired ---
function updateExpired(i){
  const val=document.getElementById(`editExpiredInput-${i}`).value.trim();
  if(!val){alert("Tanggal tidak boleh kosong"); return;}
  stock[currentIndexEditExpired].expired[i]=val;
  updateStockInFirebase(currentIndexEditExpired);
  render();
}

function hapusExpired(i){
  stock[currentIndexEditExpired].expired.splice(i,1);
  updateStockInFirebase(currentIndexEditExpired);
  render();
}

function back(){window.location.href="dashboard.html";}

// --- Load saat halaman siap ---
loadStockFromFirebase();

</script>
</body>
</html>
